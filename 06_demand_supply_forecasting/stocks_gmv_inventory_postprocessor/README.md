# Forecast Governance: Supply-Constrained Demand Planning

## 1) Какая бизнес-задача решается 

В отделе прогнозирования всегда есть две разные причины, почему план “не сошёлся” с фактом:
1. **Прогноз спроса ошибся** (модель/параметры/факторы).
2. **Товара физически не было** (поставка, распределение, остатки) - продажи “обрезались” стоком (OOS / stockout).

Если не разделять эти причины:
- модель обвиняют в “плохом прогнозе”, хотя ключевая проблема была в OOS;
- снабжение “оправдывает” дефицит тем, что “спрос был низкий”, хотя спрос был, но не исполнен;
- промо-планирование идёт вслепую: промо усиливает спрос, но нет гарантии наличия товара.

**Цель** - превратить прогноз из “цифры в отчёте” в операционный контур управления:
- считать **выполнимый план** продаж с учётом стока и целочисленности (units);
- оценивать **потери выручки из‑за OOS** (Lost Sales) в деньгах и штуках;
- оценивать **качество прогноза отдельно**:
  - “как было” по фактическим продажам,
  - “качество модели спроса” на участке, где сток не ограничивал продажи;
- выдавать **алерты и список действий** (кому, что делать) для коммерции/маркетинга/supply/DS.

На практике это то, что нужно руководителю отдела планирования:
- видеть, где проблема модели, а где проблема поставки;
- управлять потерями и предотвращать провалы промо;
- быстро объяснять отклонения и формировать корректирующие действия.

## 2) Что получается на выходе

Проект строит ежедневную/еженедельную витрину и summary-отчёт:

1. `report/governance_daily.csv` — витрина по SKU × день:
   - `forecast_units`, `forecast_gmv`
   - `feasible_units`, `feasible_gmv` (выполнимый план)
   - `actual_units`, `actual_gmv`
   - `lost_sales_units`, `lost_sales_gmv` (оценка потерь из‑за OOS)
   - `is_stock_constrained` (флаг “упёрлись в остаток”)
   - `error_non_oos_*` (метрики качества прогноза на non‑OOS участке)

2. `report/management_weekly_summary.csv` - сводка для руководства:
   - WAPE/Bias по non‑OOS (качество модели спроса)
   - доля дней/SKU с OOS‑ограничением
   - потери выручки из‑за OOS (и ТОП‑SKU/категории)

3. `report/alerts.csv` - алерты (data quality / supply / model drift) и “что делать дальше”.

## 3) Операционный процесс


1) **Регулярный прогноз** (weekly/daily):
- берём forecast (units/GMV), цены, остатки/поставки, фактические продажи;
- считаем выполнимый план `feasible_*` и потери `lost_sales_*`;
- считаем качество модели на non‑OOS сегменте;
- публикуем витрину и сводку.

2) **Промо-прогноз (SR/LR)**:
- на промо-период сравниваем прогноз спроса с обеспечением;
- если `lost_sales_gmv` (ожидаемо) высокое - либо усиливаем supply, либо корректируем промо/ассортимент.

3) **Реакция на алерты**:
- Supply Alert → снабжение/планирование распределения
- Model Alert → корректировка параметров, факторов, сезонностей
- Data Alert → DWH/SAP BW/источник

Подробно: `docs/02_operating_model.md` и `docs/05_decision_playbook.md`.

## 4) Что именно демонстрирует проект

- Расчёт регулярного и промо-прогноза в логике “выполнимость + потери”
- Очистка/валидация входных данных (data quality layer)
- Контроль KPI: точность, bias, валовое отклонение, потери из‑за OOS
- Выявление факторов: разделение ошибок модели и ограничений supply
- Подготовка отчётов руководству (готовые витрины и summary)
- Работа с большим массивом данных (логика O(N), без self‑join N×N)
- Коммуникация: перевод аналитики в действия (алерты + playbook)

## 5) Быстрый старт

### 5.1 Установка окружения
```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

### 5.2 Запуск пайплайна на демо-данных
```bash
python -m src.pipeline.run_demo   --input data/sample_input.csv   --outdir report
```

### 5.3 Запуск тестов
```bash
pytest -q
```
