# Оптимизация выручки (GMV) при соблюдении целевой взвешенной маржи категории
Инструмент планирования ценовых сценариев (regular + promo) с ограничением по взвешенной марже категории

## Контекст и бизнес-задача
В планировании спроса и промо постоянно возникает конфликт целей:

- **Коммерция / маркетинг** хотят максимизировать **GMV / выручку** за счёт скидок и промо-микса.
- **Финансы** требуют удержать **валовую прибыль** и не «уронить» **маржу категории** ниже плана.
- **Планирование спроса** отвечает за то, чтобы план был **выполнимым**: по спросу, выручке, марже и ограничениям.

Этот проект решает прикладную задачу планирования:

> Выбрать **ровно одну цену на SKU** из набора кандидатов так, чтобы **максимизировать GMV**, но при этом выполнить **финансовый guardrail**:  
> **weighted_margin(category) ≥ target_margin**.

---

## Проблематика кейса
Инструмент используется на этапе согласования ценового плана (regular + promo):

1. Формируются **ценовые кандидаты** на SKU (регулярные цены, промо-цены, ответ на конкурентов).
2. Модель/процесс прогнозирования даёт **qty** (ожидаемые продажи в штуках) на плановый горизонт при каждом кандидате цены.
3. Планирование запускает этот инструмент:
   - получает **рекомендованный price plan** (1 цена на SKU),
   - получает **итоги по категории** (GMV и взвешенная маржа),
   - получает **список действий** (что пересогласовать, где риск).
4. Если сценарий невыполним:
   - корректируется промо-микс/глубина скидки,
   - идут переговоры по cost (поставщики),
   - меняется ассортиментный вклад в GMV.

Результат: вместо “просто прогноза” появляется **управляемый план**, который можно защищать перед руководством.

---

## Концепция данных: от кандидатов цены к прогнозу GMV
Ниже показано, как из одной строки на SKU формируется несколько строк “SKU × price_candidate” и как модель отдаёт прогноз (например, GMV/qty) для каждого кандидата.

![Price candidates → model prediction pipeline](assets/01_price_candidates_pipeline.png)

---

## Экономическая логика: эластичность и trade-off
Ценовые кандидаты меняют спрос. Обычно рост цены снижает qty, и у нас появляется trade-off: где-то максимум GMV, где-то максимум маржи.

![Price elasticity and GMV trade-off](assets/02_price_elasticity_tradeoff.png)

---

## Определения и формулы
Работаем на уровне **SKU-кандидата** (каждая строка = один SKU и одна цена-кандидат).

### GMV
GMV_i = price_i * qty_i

### Маржа (margin) на SKU-кандидате
margin_i = (price_i - cost_i) / price_i

Маржа может быть отрицательной (loss leader / демпинг) - это нормально для части ассортимента.

### Взвешенная маржа категории (weighted margin)
Взвешиваем маржу вкладом SKU в выручку (пенетрацией GMV):

weighted_margin = sum(GMV_i * margin_i) / sum(GMV_i)

Целевое ограничение (guardrail):

weighted_margin >= target_margin

---

## Входные данные
Вход - таблица в формате “SKU × price_candidate”. Минимально нужны поля:

- `sku` - идентификатор SKU
- `category` - категория (или финансовая группировка)
- `cost` - себестоимость
- `price` - цена-кандидат
- `qty` - прогноз продаж (шт.) на горизонт (например, 7 дней) при данной цене

Опционально (часто нужно в реальности):
- `scenario_id` - `regular / promo / competitor_response`
- `promo_flag` - 0/1
- `price_floor`, `price_ceiling` - политики
- `stock` - наличие (если учитываем supply constraint)

Ниже — визуальная “склейка” матриц в единый входной DataFrame.

![Costs / Prices / Qty → Input DataFrame](assets/03_matrices_to_input_dataframe.png)

---

## Что именно делает алгоритм
На одном прогоне (категория + сценарий + горизонт планирования) инструмент:

1. Валидирует входные данные (пропуски, нулевая цена, отрицательный qty и т.д.).
2. Считает для каждого кандидата:
   - `GMV_i`
   - `margin_i`
3. Выбирает **по одному кандидату на SKU** так, чтобы:
   - GMV суммарно было максимальным,
   - и одновременно выполнялся guardrail: `weighted_margin >= target_margin`.

На практике выход — это маска/выбор строк “оставить/не оставить”, которая превращает кандидатов в итоговый план.

![DataFrame → mask → selected plan](assets/04_dataframe_mask_selection.png)

---

## Выходные артефакты (что отдаём бизнесу)
Цель — не просто “посчитать”, а **улучшить процесс**: дать итоговый план + объяснимость + действия.

Файлы в `outputs/`:

- `recommended_prices.csv`  
  Одна строка на SKU: выбранная цена, qty, GMV, margin, category, scenario.

- `category_summary.csv`  
  Итоги по категории: суммарный GMV, `weighted_margin`, запас до таргета (buffer), топ-вкладчики.

- `action_list.csv`  
  Список управленческих действий:
  - loss-leader SKU с большой пенетрацией GMV (риск по валовой прибыли),
  - SKU, которые “держат” маржу и критичны для выполнения таргета,
  - SKU, где выгоднее торговаться по cost / менять промо-глубину.

- `data_quality_report.csv`  
  Строки, исключенные из расчета + причина (качество данных).

- `alerts.md`  
  Текстовые алерты для оперативной реакции.

---

## Автоматические алерты (что мониторим, чтобы управлять риском)
Алерты нужны, чтобы планирование работало как система управления качеством, а не ручной расчёт:

- `infeasible_scenario`  
  Таргет по марже недостижим при любых кандидатов цен (нужен пересмотр промо-микса / cost / политики).

- `low_margin_buffer`  
  Буфер до `target_margin` слишком мал (например, < 1 п.п.) - риск срыва плана при ошибке прогноза.

- `loss_leader_penetration`  
  Отрицательная маржа у SKU с высокой долей GMV - риск по валовой прибыли.

- `top_contributors_shift`  
  Резкая смена топ-SKU по вкладу в маржу - повод проверить прогноз/себестоимость/промо.

---

## Как запускать
1) Подготовить выгрузку `data/extract.csv` (DWH/ClickHouse/Redash).  
2) Установить зависимости:
```bash
pip install -r requirements.txt

